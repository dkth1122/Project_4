<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.project.mapper.OrderMapper">

	<select id="orderCntselect" parameterType="hashmap" resultType="com.example.project.model.Order">
		SELECT
	    	U_ID, EXCHANGE,
	    COUNT(*) AS orderCnt
		FROM
		    T4_ORDER
		  WHERE U_ID = #{uId}
			GROUP BY #{uId}, EXCHANGE
	</select>
	
	
	<select id="orderProductSelect" parameterType="hashmap" resultType="com.example.project.model.Order">
	
	 SELECT * FROM
	 T4_ORDER O INNER JOIN T4_PRODUCT P ON O.P_NO = P.P_NO
	 WHERE U_ID = #{uId}
	 
	</select>
	
	<!-- 주문정보 확인 -->
	<select id="selectOrderList" parameterType="hashmap" resultType="com.example.project.model.Order">
		SELECT *
			FROM T4_ORDER O
			INNER JOIN T4_PRODUCT P ON O.P_NO = P.P_NO
			INNER JOIN T4_DELIVERY D ON O.BUY_NO = D.BUY_NO
			INNER JOIN (
				SELECT O.O_NO, COUNT(*) AS CNT
				FROM T4_ORDER O
				INNER JOIN T4_DELIVERY D ON O.BUY_NO = D.BUY_NO
				INNER JOIN T4_PRODUCT P ON O.P_NO = P.P_NO
				WHERE D_STATE = '업체확인중' AND O.O_NO = O.O_NO AND (EXCHANGE IS NULL OR EXCHANGE = '')
				GROUP BY O.O_NO)A ON O.O_NO = A.O_NO
			WHERE D_STATE = '업체확인중'
		ORDER BY O.O_NO ASC

	</select>
	
	<!-- 페이징용 카운트 -->
	<select id="selectCnt3" resultType="int">
		SELECT COUNT(*)
		FROM T4_ORDER O
		INNER JOIN T4_PRODUCT P ON O.P_NO = P.P_NO
		INNER JOIN T4_DELIVERY D ON O.BUY_NO = D.BUY_NO
		WHERE D_STATE = '업체확인중';
	</select>
	
	<!-- 오더 상태 변경 -->
	<update id="updateOrder" parameterType="hashmap">
	    UPDATE T4_DELIVERY D
	    INNER JOIN T4_ORDER O ON O.BUY_NO = D.BUY_NO
	    SET
	    	D_STATE = #{dState},
	    	EXCHANGE = #{exchange}
	    WHERE (EXCHANGE IS NULL OR EXCHANGE = '') AND O.O_NO = #{oNo}
	</update>
	
	<!-- 오더 상태 변경 개별 -->
	<update id="updateOrderInfo" parameterType="hashmap">
	    UPDATE T4_DELIVERY D
	    INNER JOIN T4_ORDER O ON O.BUY_NO = D.BUY_NO
	    SET
	    	D_STATE =#{dState},
	    	EXCHANGE = #{exchange}
	    WHERE O.BUY_NO = #{buyNo} 
	</update>
	
</mapper>